// Prisma 스키마 - Sync-Up 프로토타입
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 사용자
model User {
  id             String   @id @default(uuid())
  email          String   @unique
  passwordHash   String?  @map("password_hash")
  nickname       String   @unique
  role           UserRole
  techStacks     String   @default("[]") @map("tech_stacks")
  country        String?  // 국가
  githubId       String?  @unique @map("github_id")
  githubUsername String?  @map("github_username")
  githubToken    String?  @map("github_token") // GitHub OAuth 토큰 (암호화 저장 권장)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // 관계
  createdProjects     Project[]            @relation("ProjectCreator")
  applications        ProjectApplication[]
  chatMessages        ChatMessage[]
  evaluationsGiven    Evaluation[]         @relation("Evaluator")
  evaluationsReceived Evaluation[]         @relation("Evaluatee")
  chatRoomsAsUser1    ChatRoom[]           @relation("User1ChatRooms")
  chatRoomsAsUser2    ChatRoom[]           @relation("User2ChatRooms")

  @@map("users")
}

enum UserRole {
  DEVELOPER
  DESIGNER
  PLANNER
}

// 프로젝트
model Project {
  id               String    @id @default(uuid())
  title            String
  shortDescription String    @map("short_description")
  neededRoles      String    @default("[]") @map("needed_roles")
  requiredStacks   String    @default("[]") @map("required_stacks")
  startDate        DateTime? @map("start_date")
  endDate          DateTime? @map("end_date")
  isRecruiting     Boolean  @default(true) @map("is_recruiting")
  creatorId        String    @map("creator_id")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // 관계
  creator      User                 @relation("ProjectCreator", fields: [creatorId], references: [id])
  applications ProjectApplication[]
  chatRoom     ChatRoom?
  evaluations  Evaluation[]

  @@map("projects")
}

// 참여 신청
model ProjectApplication {
  id        String            @id @default(uuid())
  projectId String            @map("project_id")
  userId    String            @map("user_id")
  message   String?
  status    ApplicationStatus @default(PENDING)
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@unique([projectId, userId])
  @@map("project_applications")
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

// 채팅방
model ChatRoom {
  id        String   @id @default(uuid())
  projectId String?  @unique @map("project_id")
  userId1   String?  @map("user_id1")
  userId2   String?  @map("user_id2")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  project  Project?      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user1    User?         @relation("User1ChatRooms", fields: [userId1], references: [id], onDelete: Cascade)
  user2    User?         @relation("User2ChatRooms", fields: [userId2], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@unique([userId1, userId2])
  @@map("chat_rooms")
}

// 채팅 메시지
model ChatMessage {
  id                String   @id @default(uuid())
  roomId            String   @map("room_id")
  senderId          String   @map("sender_id")
  content           String
  sourceLang        String   @default("ko") @map("source_lang")
  targetLang        String?  @map("target_lang") // 실시간 번역이므로 nullable (각 사용자별로 다름)
  translatedContent String?  @map("translated_content") // 실시간 번역이므로 nullable (각 사용자별로 다름)
  createdAt         DateTime @default(now()) @map("created_at")

  room   ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender User     @relation(fields: [senderId], references: [id])

  @@map("chat_messages")
}

// 평가 (뼈대만, TODO: 실제 구현 예정)
model Evaluation {
  id            String   @id @default(uuid())
  projectId     String   @map("project_id")
  evaluatorId   String   @map("evaluator_id")
  evaluateeId   String   @map("evaluatee_id")
  sincerity     Int
  communication Int
  contribution  Int
  createdAt     DateTime @default(now()) @map("created_at")

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  evaluator User    @relation("Evaluator", fields: [evaluatorId], references: [id])
  evaluatee User    @relation("Evaluatee", fields: [evaluateeId], references: [id])

  @@unique([projectId, evaluatorId, evaluateeId])
  @@map("evaluations")
}

// 언어별 릴리즈 정보
model Release {
  id              String   @id @default(uuid())
  language        String // 예: "TypeScript", "Python", "Node.js", "React" 등
  version         String // 버전 번호 (예: "5.3.0")
  releaseDate     DateTime @map("release_date")
  officialDocs    String   @map("official_docs") // 공식 문서 URL
  officialContent String   @map("official_content") // 공식 문서 핵심 내용 (원문)
  summary         String // 간략 정리 내용
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([language, version])
  @@map("releases")
}
